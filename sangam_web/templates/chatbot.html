{% extends "base.html" %}

{% block title %}Sangam Sathi - Chatbot{% endblock %}

{% block content %}
<div class="h-screen flex flex-col bg-gradient-to-br from-indigo-50 via-purple-50 to-orange-50">
    <!-- Enhanced Header -->
    <div class="glass-effect border-b border-white/20 p-6 shadow-glow">
        <div class="flex items-center">
            <button onclick="window.close()" class="mr-6 w-12 h-12 rounded-2xl bg-white/20 hover:bg-white/30 flex items-center justify-center transition-all duration-300 hover:scale-110">
                <i class="fas fa-arrow-left text-white text-xl"></i>
            </button>
            <div class="relative mr-4">
                <div class="absolute inset-0 bg-gradient-primary rounded-full blur-md opacity-50 animate-pulse-slow"></div>
                <div class="relative w-16 h-16 bg-white/20 rounded-full p-3 animate-float">
                    <img src="{{ url_for('static', filename='assets/chatbot_icon.png') }}" alt="Sangam Sathi" class="w-full h-full rounded-full object-cover">
                </div>
            </div>
            <div>
                <h1 class="text-3xl font-bold text-white font-playfair mb-1">Sangam Sathi</h1>
                <p class="text-white/80 font-medium">Your AI Travel Companion</p>
            </div>
        </div>
    </div>
    
    <!-- Enhanced Chat Messages Container -->
    <div class="flex-1 overflow-y-auto p-6 space-y-6" id="messagesContainer">
        <!-- Enhanced Welcome message -->
        <div class="animate-fade-in">
            <div class="flex items-start">
                <div class="flex-shrink-0 mr-4">
                    <div class="w-12 h-12 bg-gradient-primary rounded-2xl p-2 shadow-glow">
                        <img src="{{ url_for('static', filename='assets/chatbot_icon.png') }}" alt="Bot" class="w-full h-full rounded-full object-cover">
                    </div>
                </div>
                <div class="card-modern p-4 max-w-md shadow-medium bg-gradient-to-br from-blue-50 to-indigo-50 border-l-4 border-blue-500">
                    <p class="text-gray-800 font-medium leading-relaxed">üôè Namaste! I am <span class="font-bold text-gradient">Sangam Sathi</span>. How can I help you plan your sacred Ujjain yatra?</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Enhanced Loading indicator -->
    <div id="loadingIndicator" class="px-6 pb-4 hidden">
        <div class="flex items-center animate-fade-in">
            <div class="flex-shrink-0 mr-4">
                <div class="w-12 h-12 bg-gradient-primary rounded-2xl p-2 shadow-glow animate-pulse">
                    <img src="{{ url_for('static', filename='assets/chatbot_icon.png') }}" alt="Bot" class="w-full h-full rounded-full object-cover">
                </div>
            </div>
            <div class="card-modern p-4 shadow-medium bg-gradient-to-br from-purple-50 to-pink-50">
                <div class="flex items-center space-x-2">
                    <div class="flex space-x-1">
                        <div class="w-3 h-3 bg-gradient-primary rounded-full animate-bounce"></div>
                        <div class="w-3 h-3 bg-gradient-primary rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                        <div class="w-3 h-3 bg-gradient-primary rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                    </div>
                    <span class="text-gray-600 font-medium ml-2">Thinking...</span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Enhanced Input Container -->
    <div class="glass-effect border-t border-white/20 p-6 shadow-glow">
        <div class="flex items-center space-x-4">
            <div class="flex-1 relative">
                <input 
                    type="text" 
                    id="messageInput" 
                    placeholder="Ask me about Ujjain temples, festivals, or travel tips..."
                    class="w-full pl-6 pr-4 py-4 bg-white/90 border-2 border-white/30 rounded-2xl focus:ring-4 focus:ring-orange-200 focus:border-primary-orange focus:bg-white outline-none text-lg font-medium transition-all duration-300 shadow-medium"
                    onkeypress="handleKeyPress(event)"
                >
            </div>
            <button 
                id="sendButton"
                onclick="sendMessage()" 
                class="w-16 h-16 bg-gradient-primary hover:shadow-colored text-white rounded-2xl flex items-center justify-center transition-all duration-300 hover:scale-110 shadow-glow"
            >
                <i class="fas fa-paper-plane text-xl"></i>
            </button>
        </div>
    </div>
</div>

<script>
let isLoading = false;

function handleKeyPress(event) {
    if (event.key === 'Enter' && !isLoading) {
        sendMessage();
    }
}

async function sendMessage() {
    const input = document.getElementById('messageInput');
    const message = input.value.trim();
    
    if (!message || isLoading) return;
    
    // Add user message to chat
    addMessage(message, true);
    input.value = '';
    
    // Show loading indicator
    showLoading(true);
    
    try {
        const response = await fetch('/api/chatbot', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ message: message })
        });
        
        const data = await response.json();
        
        // Add bot response
        addMessage(data.response || 'Sorry, I could not understand that.', false);
        
    } catch (error) {
        addMessage('Sorry, I am experiencing technical difficulties. Please try again later.', false);
    } finally {
        showLoading(false);
    }
}

function addMessage(text, isUser) {
    const container = document.getElementById('messagesContainer');
    const messageDiv = document.createElement('div');
    messageDiv.className = 'mb-4';
    
    if (isUser) {
        messageDiv.innerHTML = `
            <div class="flex items-start justify-end animate-fade-in">
                <div class="card-modern p-4 max-w-md shadow-medium bg-gradient-primary text-white mr-4">
                    <p class="font-medium leading-relaxed">${text}</p>
                </div>
                <div class="flex-shrink-0">
                    <div class="w-12 h-12 bg-gradient-to-br from-orange-400 to-pink-500 rounded-2xl flex items-center justify-center shadow-glow">
                        <i class="fas fa-user text-white text-lg"></i>
                    </div>
                </div>
            </div>
        `;
    } else {
        messageDiv.innerHTML = `
            <div class="flex items-start animate-fade-in">
                <div class="flex-shrink-0 mr-4">
                    <div class="w-12 h-12 bg-gradient-primary rounded-2xl p-2 shadow-glow">
                        <img src="{{ url_for('static', filename='assets/chatbot_icon.png') }}" alt="Bot" class="w-full h-full rounded-full object-cover">
                    </div>
                </div>
                <div class="card-modern p-4 max-w-md shadow-medium bg-gradient-to-br from-blue-50 to-indigo-50 border-l-4 border-blue-500">
                    <p class="text-gray-800 font-medium leading-relaxed">${text}</p>
                </div>
            </div>
        `;
    }
    
    container.appendChild(messageDiv);
    container.scrollTop = container.scrollHeight;
}

function showLoading(show) {
    isLoading = show;
    const loadingIndicator = document.getElementById('loadingIndicator');
    const sendButton = document.getElementById('sendButton');
    
    if (show) {
        loadingIndicator.classList.remove('hidden');
        sendButton.classList.add('opacity-50', 'cursor-not-allowed');
    } else {
        loadingIndicator.classList.add('hidden');
        sendButton.classList.remove('opacity-50', 'cursor-not-allowed');
    }
    
    // Scroll to bottom
    const container = document.getElementById('messagesContainer');
    container.scrollTop = container.scrollHeight;
}

// Focus input on load
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('messageInput').focus();
});
</script>
{% endblock %}